<!doctype html><html lang=ja><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-158035573-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-158035573-1');</script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>内部で GitHub API を用いる GitHub Actions を、 github.com と GitHub Enterprise の両方に対応させる | tbsmcd.net</title><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/code.css><link rel=stylesheet href=/css/fonts.css><link rel=stylesheet href=/css/custom.css><script src=/js/theme.js async></script><link rel=apple-touch-icon sizes=57x57 href=/apple-icon-57x57.png><link rel=apple-touch-icon sizes=60x60 href=/apple-icon-60x60.png><link rel=apple-touch-icon sizes=72x72 href=/apple-icon-72x72.png><link rel=apple-touch-icon sizes=76x76 href=/apple-icon-76x76.png><link rel=apple-touch-icon sizes=114x114 href=/apple-icon-114x114.png><link rel=apple-touch-icon sizes=120x120 href=/apple-icon-120x120.png><link rel=apple-touch-icon sizes=144x144 href=/apple-icon-144x144.png><link rel=apple-touch-icon sizes=152x152 href=/apple-icon-152x152.png><link rel=apple-touch-icon sizes=180x180 href=/apple-icon-180x180.png><link rel=icon type=image/png sizes=192x192 href=/android-icon-192x192.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=96x96 href=/favicon-96x96.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><meta name=msapplication-TileColor content="#ffffff"><meta name=msapplication-TileImage content="/ms-icon-144x144.png"><meta name=theme-color content="#ffffff"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@tbsmcd"><meta name=twitter:creator content="@tbsmcd"><meta property="og:url" content="https://tbsmcd.net/post/using-github-event-path/"><meta property="og:title" content="内部で GitHub API を用いる GitHub Actions を、 github.com と GitHub Enterprise の両方に対応させる | tbsmcd"><meta property="og:description" content="GitHub Actions を github.com/GitHub Enterprise で共通化するためには ${{ github.event }}/GITHUB_EVENT_PATH が有効的。特に API を叩く時には便利。"><meta name=description content="GitHub Actions を github.com/GitHub Enterprise で共通化するためには ${{ github.event }}/GITHUB_EVENT_PATH が有効的。特に API を叩く時には便利。"><meta property="og:image" content="https://tbsmcd.net/post/using-github-event-path/header.png"></head><body><header>tbsmcd.net <a href=/><span>index</span></a>, <a href=/archives/><span>archives</span></a>, <a href=/tags/><span>tags</span></a>, <a href=/search/><span>search</span></a>, <a href=/profile/><span>profile</span></a> <input type=checkbox id=cb-dark-theme> Dark theme</header><main><h1 class=h1-mono-post><span>内部で GitHub API を用いる GitHub Actions を、 github.com と GitHub Enterprise の両方に対応させる</span></h1><p class=article-date>2021-03-17 01:12:39 +0900</p><div class=in-article-list><p class="in-article-list-p series-name">Series: label_timer</p><ul class=page-list><li>2021-03-11 <a href=/post/label-timer/>Issue, Pull Request のリードタイムを計測できる GitHub Action「Label timer」をリリースした</a></li><li>2021-03-17 内部で GitHub API を用いる GitHub Actions を、 github.com と GitHub Enterprise の両方に対応させる</li></ul></div><p>この記事は <a href=https://github.com/marketplace/actions/label-timer>Label timer</a> を開発したことで得られた知見。</p><h2 id=github-enterprise--githubcom--api->GitHub Enterprise と github.com で異なる API エンドポイント</h2><p>　例えば GitHub API の <a href=https://api.github.com/foo>https://api.github.com/foo</a> に相当するものが GitHub Enterprise では https://[独自ドメイン]/api/v3/foo となるので、同一の Action を両者間で使いまわそうと思うと多少の工夫が必要だ。個人や社内で使う目的ならエンドポイントを固定してしまうのも良いだろうが、OSS として考えれば両方で使えたほうが嬉しいはずだ。</p><h2 id=heading>共通化させる方法</h2><p>　おそらくいろいろなやり方があると思う。パッと思いついたものとしては、エンドポイントを .github/workflows/foo.yml の中で記す方法などが考えられる。action.yml と .github/workflows/foo.yml の記述は以下のように。</p><div class=highlight><pre class=chroma><code class=language-yml:action.yml data-lang=yml:action.yml>inputs<span class=p>:</span><span class=w>
</span><span class=w>  </span>api_endpoint<span class=p>:</span><span class=w>
</span><span class=w>    </span>description<span class=p>:</span><span class=w> </span>If<span class=w> </span>you<span class=w> </span>use<span class=w> </span>GitHub<span class=w> </span>Enterprise<span class=p>,</span><span class=w> </span>specify<span class=w> </span>the<span class=w> </span>endpoint.<span class=w>
</span><span class=w>    </span><span class=c># GitHub を使う場合には指定する必要がないように</span><span class=w>
</span><span class=w>    </span>default<span class=p>:</span><span class=w> </span>https<span class=p>:</span>//api.github.com/<span class=w>
</span></code></pre></div><div class=highlight><pre class=chroma><code class=language-yml:foo.yml data-lang=yml:foo.yml>jobs<span class=p>:</span><span class=w>
</span><span class=w>  </span>foo<span class=p>:</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>runs-on<span class=p>:</span><span class=w> </span>ubuntu-latest<span class=w>
</span><span class=w>    </span>steps<span class=p>:</span><span class=w>
</span><span class=w>      </span>-<span class=w> </span>name<span class=p>:</span><span class=w> </span>test_run<span class=w>
</span><span class=w>        </span>uses<span class=p>:</span><span class=w> </span>foo/bar@<span class=m>1</span><span class=w>
</span><span class=w>        </span>id<span class=p>:</span><span class=w> </span>test_run<span class=w>
</span><span class=w>        </span>with<span class=p>:</span><span class=w>
</span><span class=w>          </span>api_endpoint<span class=p>:</span><span class=w> </span>https<span class=p>:</span>//<span class=p>[</span>your_domain<span class=p>]</span>/api/v3/<span class=w>
</span></code></pre></div><p>　さて、今回 Issue_timer を作るにあたっては <code>GITHUB_EVENT_PATH</code> を用いてワークフローをトリガするイベントを取得し、その中に記載のある API エンドポイントにアクセスする方法を採用した。この方法だと workflows/foo.yml でエントリーポイントを指定する必要もない。</p><p><a href=https://docs.github.com/ja/actions/reference/events-that-trigger-workflows>ワークフローをトリガーするイベント - GitHub Docs</a></p><p>　Actions のスクリプト中では <code>GITHUB_EVENT_PATH</code> を用いて上記ドキュメント中の <code>${{ github.event }}</code> に相当する内容の json ファイルを取得することができる。たとえば Python なら以下のように。Pull Request にラベルが付いたことをトリガとするものであれば、 <code>action</code> には <code>labeled</code> が代入される。</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>environ</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>GITHUB_EVENT_PATH</span><span class=s1>&#39;</span><span class=p>)</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
    <span class=n>events</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>f</span><span class=p>)</span>
    <span class=n>action</span> <span class=o>=</span> <span class=n>events</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>action</span><span class=s1>&#39;</span><span class=p>]</span>
</code></pre></div><p>　この <code>events</code> には API エンドポイントや各種 URL も含まれている。例として Pull Request に対する何らかのアクションがトリガであれば以下のようなコードでトリガとなった Pull Request の URL や Pull Request のコメントを操作する API エンドポイントを取得できる。</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=n>url</span> <span class=o>=</span> <span class=n>events</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>pull_request</span><span class=s1>&#39;</span><span class=p>]</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>_links</span><span class=s1>&#39;</span><span class=p>]</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>html</span><span class=s1>&#39;</span><span class=p>]</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>href</span><span class=s1>&#39;</span><span class=p>]</span>
<span class=n>api_url</span> <span class=o>=</span> <span class=n>events</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>pull_request</span><span class=s1>&#39;</span><span class=p>]</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>_links</span><span class=s1>&#39;</span><span class=p>]</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>comments</span><span class=s1>&#39;</span><span class=p>]</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>href</span><span class=s1>&#39;</span><span class=p>]</span>
</code></pre></div><p>　今回は github.com の Marketplace で公開することをを目標にしつつ社内の GitHub Enterprise でも使えることを考えていたので、このような工夫が必要だった。単に Marketplace に公開する場合にはそのような配慮は必要ないかもしれないが、少しの工夫で多くの人が使えるようになれば、その方が面白いと思う。</p></main><p>Tags:
<a href=/tags/github-actions>GitHub Actions</a></p><footer><hr>Written by Mochida Tsubasa(@tbsmcd). <a href=https://docs.google.com/forms/d/e/1FAIpQLScLrngN5Znk15zTy06N9qjO3Mi_ubIrXrX9cfYFid_2-mmbQQ/viewform>Contact</a> <a href=/index.xml>Feed</a></footer></body></html>