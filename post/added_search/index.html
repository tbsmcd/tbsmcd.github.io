<!doctype html><html lang=ja><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-158035573-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-158035573-1');</script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Vue.js + lunr.js を使い hugo サイトに全文検索を追加する | tbsmcd.net</title><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/scss/code.min.daf683076712a8fd05c112ad6575fb841b4d15640f4c87e71541744189b69260.css><link rel=stylesheet href=/css/fonts.css><link rel=stylesheet href=/scss/custom.min.81a89547eff4fcc5b92e5048e6a2013346ea76400e7201e3ed1ee5342ff34ccc.css><script src=/js/theme.js defer></script><link rel=apple-touch-icon sizes=57x57 href=/apple-icon-57x57.png><link rel=apple-touch-icon sizes=60x60 href=/apple-icon-60x60.png><link rel=apple-touch-icon sizes=72x72 href=/apple-icon-72x72.png><link rel=apple-touch-icon sizes=76x76 href=/apple-icon-76x76.png><link rel=apple-touch-icon sizes=114x114 href=/apple-icon-114x114.png><link rel=apple-touch-icon sizes=120x120 href=/apple-icon-120x120.png><link rel=apple-touch-icon sizes=144x144 href=/apple-icon-144x144.png><link rel=apple-touch-icon sizes=152x152 href=/apple-icon-152x152.png><link rel=apple-touch-icon sizes=180x180 href=/apple-icon-180x180.png><link rel=icon type=image/png sizes=192x192 href=/android-icon-192x192.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=96x96 href=/favicon-96x96.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><meta name=msapplication-TileColor content="#ffffff"><meta name=msapplication-TileImage content="/ms-icon-144x144.png"><meta name=theme-color content="#ffffff"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@tbsmcd"><meta name=twitter:creator content="@tbsmcd"><meta property="og:url" content="https://tbsmcd.net/post/added_search/"><meta property="og:title" content="Vue.js + lunr.js を使い hugo サイトに全文検索を追加する | tbsmcd"><meta property="og:description" content="Vue.js + lunr.js + hugo で全文検索を実現する方法"><meta name=description content="Vue.js + lunr.js + hugo で全文検索を実現する方法"><meta property="og:image" content="https://tbsmcd.net/post/added_search/lrv.png"></head><body><div class=wrapper><header>tbsmcd.net <a href=/><span>index</span></a>, <a href=/archives/><span>archives</span></a>, <a href=/tags/><span>tags</span></a>, <a href=/search/><span>search</span></a>, <a href=/profile/><span>profile</span></a> <input type=checkbox id=cb-dark-theme> Dark theme</header><main><h1 class=h1-mono-post><span>Vue.js + lunr.js を使い hugo サイトに全文検索を追加する</span></h1><div class=article-date-box><p class=article-date>Created: 2020-03-06</p></div><a href=/post/added_search/lrv.png><img src=/post/added_search/lrv.png alt=月面バギーのイラストです></a><h2 id=heading>成果物</h2><ul><li><a href=/search/>/search/</a></li></ul><h2 id=-html->生の html を書きたい</h2><p>hugo では Markdown を使う。一般的な Markdown では html を混在して書けるが、 hugo では以下のようになる。</p><p>index.md</p><div class=highlight><pre class=chroma><code class=language-html data-lang=html><span class=p>&lt;</span><span class=nt>a</span> <span class=na>href</span><span class=o>=</span><span class=s>&#34;#&#34;</span><span class=p></span><span class=p>&gt;</span><span class=p>&lt;</span><span class=nt>img</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;/img.jpg&#34;</span><span class=p></span><span class=p>&gt;</span><span class=p>&lt;</span><span class=p>/</span><span class=nt>a</span><span class=p>&gt;</span>
</code></pre></div><p>↓
index.html</p><div class=highlight><pre class=chroma><code class=language-html data-lang=html><span class=p>&lt;</span><span class=nt>p</span><span class=p></span><span class=p>&gt;</span><span class=p>&lt;</span><span class=nt>a</span> <span class=na>href</span><span class=o>=</span><span class=s>&#34;#&#34;</span><span class=p></span><span class=p>&gt;</span><span class=p>&lt;</span><span class=nt>img</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;/img.jpg&#34;</span><span class=p></span><span class=p>&gt;</span><span class=p>&lt;</span><span class=p>/</span><span class=nt>a</span><span class=p>&gt;</span><span class=p>&lt;</span><span class=p>/</span><span class=nt>p</span><span class=p>&gt;</span>
</code></pre></div><p>このように p タグで囲われた状態で出力されるため、たとえば Amazon のアフィリエイトを貼り付けると無駄な改行が入ってしまう。このままでは JavaScript でページを作る上で多少の不都合がある（表現が自由ではない）ので、生の html を出力する shortcode を作成する。</p><p>/layouts/shortcodes/raw.html</p><pre><code>{{ .Inner }}
</code></pre><p><a href=https://raw.githubusercontent.com/tbsmcd/tbsmcd.github.io/d1fec30baee1b995c80a18ab6ae5baabd0f27425/content/post/my_desk/index.md>このように</a>使える。</p><p>参照: <a href=https://anaulin.org/blog/hugo-raw-html-shortcode/>Simple Shortcode to Insert Raw HTML in Hugo · Ana Ulin</a></p><h2 id=indexjson->index.json を出力する</h2><p>今回は <a href=https://fabiofranchino.com/blog/how-to-make-a-client-side-search-engine-with-vue-and-lunr/>How to make a client-side search engine with Vue.js and Lunr.js - Fabio Franchino</a> の方法を<del>パク</del>踏襲して、まずは動かしてみる。リンク先のコードにおいて <code>axios</code> で読み込む json に相当する情報を hugo で出力する必要があるので、それを index.json とする。 /layouts/_default/index.json に layout を、config.toml に設定を追加すれば index.xml (RSS)のように出力することが出来る。</p><p>/layouts/_default/index.json</p><pre><code>{{ $items := slice }}

{{ $counter := 0 }}
{{ range .Site.RegularPages }}
  {{ if in .Permalink &quot;/post/&quot; }}
  {{ $counter = add $counter 1 }}
  {{ $date := .Date.Format &quot;2006-01-02&quot; }}
  {{ $items = $items | append (dict &quot;id&quot; $counter &quot;title&quot; .Title &quot;body&quot; .Plain &quot;url&quot; .Permalink &quot;date&quot; $date) }}
  {{ end }}
{{ end }}

{{ $items | jsonify }}
</code></pre><p>単純に slice として定義した <code>$items</code> にページの内容を dict として追加していっている。<code>id</code> は今回のソースでは使用するというだけで、別に <code>url</code> を同じく用いてもよいだろうと思う（検証はしていないが）。何も考えず全ページを追加すると /profile/ や /search/ 自身まで対象となるので、リンクに <code>/post/</code> が含まれるページだけという条件をつけている（<code>if in .Permalink "/post/"</code>）。最終行ではループで組み立てた $items を <code>jsonfy</code> で json 化して出力している。</p><p>同じようなことを解説しているページで .Scratch を使っているパターンがあるが、このように単一ページで用いるだけの変数には必要のないと思う。<a href=https://gohugo.io/functions/scratch/>ドキュメント</a>には <code>allow for writable page- or shortcode-scoped variables.</code> とある。スコープをまたぐときに使うように読めるが、今回は関係ない。物事はシンプルに記述したほうが良いだろう。</p><p>また config.toml にはこのように。</p><pre><code>[outputs]
home = [&quot;html&quot;, &quot;json&quot;, &quot;rss&quot;]
</code></pre><h2 id=heading-1>検索ページを設置する</h2><p>search.md</p><ul><li><a href=https://github.com/tbsmcd/tbsmcd.github.io/blob/ed52a5bca0f828d3c046bef2bdc3577d3150c38e/content/search.md>https://github.com/tbsmcd/tbsmcd.github.io/blob/ed52a5bca0f828d3c046bef2bdc3577d3150c38e/content/search.md</a></li></ul><p>lunr.js は<a href=https://github.com/olivernn/lunr.js>ここ</a>から、lunr.stemmer.support.js tinyseg.js lunr.ja.js は<a href=https://github.com/MihaiValentin/lunr-languages>ここ</a>からダウンロードする。</p><p>search.js</p><ul><li><a href=https://github.com/tbsmcd/tbsmcd.github.io/blob/ed52a5bca0f828d3c046bef2bdc3577d3150c38e/static/js/search.js>https://github.com/tbsmcd/tbsmcd.github.io/blob/ed52a5bca0f828d3c046bef2bdc3577d3150c38e/static/js/search.js</a></li></ul><p>検索対象が本文とタイトルなので、そのように指定している。</p><p><a href=https://github.com/MihaiValentin/lunr-languages>lunr-languages の README</a> では多言語に対応する方法として</p><pre><code>this.use(lunr.multiLanguage('en', 'ru'));
</code></pre><p>と書かれているのだが、同じように日本語を、例えば <code>'en', 'ja'</code> のように指定しても希望通り動かない（英語だけが有効になる）。これは既知の問題のようだ。</p><ul><li><a href=https://github.com/MihaiValentin/lunr-languages/issues/45>&ldquo;multiLanguage&rdquo; method doesn't work with Japanese. #45 · MihaiValentin/lunr-languages</a></li></ul><p>そのため今回は <code>this.use(lunr.ja)</code> と日本語だけを検索するよう書いたのだが、もちろん多言語対応していないので次は英単語の resource などを検索できない問題が生じる。そのため姑息的対処として <code>this.resuls = this.searchIndex.search(</code>*${this.search}*<code>)</code> でワイルドカードで検索できるようにした。これで resource なども検索できるのだが、ならばいっそ lunr を使わず Vue だけで検索を作っても良いのではないかという気にもなる…… lunr-languages に貢献するのがいちばん良いのかな。</p><p>以上で検索ページは実現できる。</p><h2 id=heading-2>今後</h2><ul><li>全記事を表示してから絞り込み検索するのはページ増えたときに……<ul><li>ページが増えたときに考えましょう</li></ul></li><li>全記事を json で吐き出すのは……<ul><li>ページが増えたときに考えましょう</li></ul></li></ul></main><p>Tags:
<a href=/tags/hugo>hugo</a>
<a href=/tags/vue.js>Vue.js</a>
<a href=/tags/lunr.js>lunr.js</a></p><footer>Mochida Tsubasa<br>(@tbsmcd)<br><a href=https://docs.google.com/forms/d/e/1FAIpQLScLrngN5Znk15zTy06N9qjO3Mi_ubIrXrX9cfYFid_2-mmbQQ/viewform>Contact</a>, <a href=/index.xml>Feed</a></footer></div></body></html>