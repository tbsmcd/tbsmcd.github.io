<!doctype html><html lang=ja><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-158035573-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-158035573-1');</script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>GitHub Actions を使って docker build し Docker Hub に push すると、速くて良い | tbsmcd.net</title><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/scss/code.min.daf683076712a8fd05c112ad6575fb841b4d15640f4c87e71541744189b69260.css><link rel=stylesheet href=/css/fonts.css><link rel=stylesheet href=/scss/custom.min.20d03a5f647985ade694e4930c00278b5a2d34642b5fb17a014e353bc48934a4.css><script src=/js/main.js defer></script><link rel=apple-touch-icon sizes=57x57 href=/apple-icon-57x57.png><link rel=apple-touch-icon sizes=60x60 href=/apple-icon-60x60.png><link rel=apple-touch-icon sizes=72x72 href=/apple-icon-72x72.png><link rel=apple-touch-icon sizes=76x76 href=/apple-icon-76x76.png><link rel=apple-touch-icon sizes=114x114 href=/apple-icon-114x114.png><link rel=apple-touch-icon sizes=120x120 href=/apple-icon-120x120.png><link rel=apple-touch-icon sizes=144x144 href=/apple-icon-144x144.png><link rel=apple-touch-icon sizes=152x152 href=/apple-icon-152x152.png><link rel=apple-touch-icon sizes=180x180 href=/apple-icon-180x180.png><link rel=icon type=image/png sizes=192x192 href=/android-icon-192x192.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=96x96 href=/favicon-96x96.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><meta name=msapplication-TileColor content="#ffffff"><meta name=msapplication-TileImage content="/ms-icon-144x144.png"><meta name=theme-color content="#ffffff"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@tbsmcd"><meta name=twitter:creator content="@tbsmcd"><meta property="og:url" content="https://tbsmcd.net/post/github-docker-build-and-push/"><meta property="og:title" content="GitHub Actions を使って docker build し Docker Hub に push すると、速くて良い | tbsmcd"><meta property="og:description" content="GitHub Actions を使って Docker イメージをビルドし Docker Hub に push すると速くて便利だった。"><meta name=description content="GitHub Actions を使って Docker イメージをビルドし Docker Hub に push すると速くて便利だった。"><meta property="og:image" content="https://tbsmcd.net/post/github-docker-build-and-push/gh.png"></head><body><div class=wrapper><header><div class=title-container><div class=title-item>tbsmcd.net</div><div class=title-item><input type=checkbox id=cb-dark-theme> Dark theme</div></div><div><a href=/><span>index</span></a>, <a href=/archives/><span>archives</span></a>, <a href=/tags/><span>tags</span></a>, <a href=/search/><span>search</span></a>, <a href=/profile/><span>profile</span></a></div></header><main><h1 class=h1-mono-post><span>GitHub Actions を使って docker build し Docker Hub に push すると、速くて良い</span></h1><div class=article-date-box><p class=article-date>Created: 2020-11-26</p></div><h2 id=github-actions->GitHub Actions がキテる</h2><p>　2019年11月に GitHub Actions （以下 GHA）が正式に公開されて以来、おもに CI/CD を GHA に乗り換える事が増えていると思う。その後 GitHub Enterprise でも GHA が使用可能になり、弊社（GMO ペパボ）でもその動きが活発化している。じぶんはふだん Web アプリケーションのデプロイの一環として GHA を捉えているのだけど、 GHA でできるのはそれだけにとどまらない。<br>　さいきん自然言語処理の練習用に <a href=https://github.com/tbsmcd/NLP_PyTorch>Dockerfile を書いた</a>。個人用のローカルマシンでビルドして使っているのだけど、業務でも使いたいという野望もあり、それならば2箇所でビルドするよりイメージを共有できたら良い。だったら GHA でビルドできるのでは？と考え調べると簡単にできるらしいことがわかった。</p><h2 id=heading>やりたいこと</h2><p>　手元のマシンで <code>$ git tag [tag] && git push origin [tag]</code> したら Docker イメージのビルドをして Docker Hub にプッシュまでを自動化したい。その際に例えば GitHub では <code>v0.0.1</code> というタグを打った場合に、 Docker Hub では <code>0.0.1</code> と <code>latest</code> というタグを使いたい。</p><h2 id=-workflow>実際の Workflow</h2><p>　リポジトリ <a href=https://github.com/tbsmcd/NLP_PyTorch>tbsmcd/NLP_PyTorch</a></p><div class=highlight><pre class=chroma><code class=language-yml data-lang=yml>name<span class=p>:</span><span class=w> </span>Publish<span class=w> </span>Docker<span class=w> </span>image<span class=w>
</span><span class=w></span>on<span class=p>:</span><span class=w>
</span><span class=w>  </span>push<span class=p>:</span><span class=w>
</span><span class=w>    </span>tags<span class=p>:</span><span class=w>
</span><span class=w>      </span>-<span class=w> </span><span class=s1>&#39;v*.*.*&#39;</span><span class=w>
</span><span class=w></span>jobs<span class=p>:</span><span class=w>
</span><span class=w>  </span>push_to_registry<span class=p>:</span><span class=w>
</span><span class=w>    </span>name<span class=p>:</span><span class=w> </span>Push<span class=w> </span>Docker<span class=w> </span>image<span class=w> </span>to<span class=w> </span>Docker<span class=w> </span>Hub<span class=w>
</span><span class=w>    </span>runs-on<span class=p>:</span><span class=w> </span>ubuntu-latest<span class=w>
</span><span class=w>    </span>steps<span class=p>:</span><span class=w>
</span><span class=w>      </span>-<span class=w> </span>name<span class=p>:</span><span class=w> </span>Check<span class=w> </span>out<span class=w> </span>the<span class=w> </span>repo<span class=w>
</span><span class=w>        </span>uses<span class=p>:</span><span class=w> </span>actions/checkout@v2<span class=w>
</span><span class=w>      </span>-<span class=w> </span>name<span class=p>:</span><span class=w> </span>Get<span class=w> </span>version<span class=w> </span>number<span class=w>
</span><span class=w>        </span>id<span class=p>:</span><span class=w> </span>tag_number<span class=w>
</span><span class=w>        </span>run<span class=p>:</span><span class=w> </span><span class=sd>|
</span><span class=sd>         </span><span class=sd> </span><span class=sd>CURRENT_TAG=$(git tag --sort=-creatordate | sed -n 1p)</span><span class=w>
</span><span class=w>          </span>DOCKERHUB_TAG=<span class=s2>&#34;${CURRENT_TAG//v/}&#34;</span><span class=w>
</span><span class=w>          </span>echo<span class=w> </span><span class=s2>&#34;::set-output name=dh_tag::${DOCKERHUB_TAG}&#34;</span><span class=w>
</span><span class=w>      </span>-<span class=w> </span>name<span class=p>:</span><span class=w> </span>Set<span class=w> </span>up<span class=w> </span>Docker<span class=w> </span>Buildx<span class=w>
</span><span class=w>        </span>uses<span class=p>:</span><span class=w> </span>docker/setup-buildx-action@v1<span class=w>
</span><span class=w>      </span>-<span class=w> </span>name<span class=p>:</span><span class=w> </span>Login<span class=w> </span>to<span class=w> </span>DockerHub<span class=w>
</span><span class=w>        </span>uses<span class=p>:</span><span class=w> </span>docker/login-action@v1<span class=w>
</span><span class=w>        </span>with<span class=p>:</span><span class=w>
</span><span class=w>          </span>username<span class=p>:</span><span class=w> </span>${{<span class=w> </span>secrets.DOCKER_USERNAME<span class=w> </span>}}<span class=w>
</span><span class=w>          </span>password<span class=p>:</span><span class=w> </span>${{<span class=w> </span>secrets.DOCKER_PASSWORD<span class=w> </span>}}<span class=w>
</span><span class=w>      </span>-<span class=w> </span>name<span class=p>:</span><span class=w> </span>Build<span class=w> </span>and<span class=w> </span>Push<span class=w> </span>to<span class=w> </span>Docker<span class=w> </span>Hub<span class=w>
</span><span class=w>        </span>uses<span class=p>:</span><span class=w> </span>docker/build-push-action@v2<span class=w>
</span><span class=w>        </span>with<span class=p>:</span><span class=w>
</span><span class=w>          </span>context<span class=p>:</span><span class=w> </span>.<span class=w>
</span><span class=w>          </span>push<span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>          </span>tags<span class=p>:</span><span class=w> </span><span class=sd>|
</span><span class=sd>           </span><span class=sd> </span><span class=sd>tbsmcd/nlp_pytorch:latest</span><span class=w>
</span><span class=w>            </span>tbsmcd/nlp_pytorch<span class=p>:</span>${{steps.tag_number.outputs.dh_tag}}<span class=w>
</span></code></pre></div><p>　docker/setup-buildx-action, docker/login-action, docker/build-push-action あたりの使い方は各リポジトリを見たらわかると思う。</p><div class=highlight><pre class=chroma><code class=language-yml data-lang=yml>on<span class=p>:</span><span class=w>
</span><span class=w>  </span>push<span class=p>:</span><span class=w>
</span><span class=w>    </span>tags<span class=p>:</span><span class=w>
</span><span class=w>      </span>-<span class=w> </span><span class=s1>&#39;v*.*.*&#39;</span><span class=w>
</span></code></pre></div><p>の箇所では <code>v*.*.*</code> に当てはまるタグを付けた場合に動くようにしている。</p><div class=highlight><pre class=chroma><code class=language-yml data-lang=yml><span class=w>      </span>-<span class=w> </span>name<span class=p>:</span><span class=w> </span>Get<span class=w> </span>version<span class=w> </span>number<span class=w>
</span><span class=w>        </span>id<span class=p>:</span><span class=w> </span>tag_number<span class=w>
</span><span class=w>        </span>run<span class=p>:</span><span class=w> </span><span class=sd>|
</span><span class=sd>         </span><span class=sd> </span><span class=sd>CURRENT_TAG=$(git tag --sort=-creatordate | sed -n 1p)</span><span class=w>
</span><span class=w>          </span>DOCKERHUB_TAG=<span class=s2>&#34;${CURRENT_TAG//v/}&#34;</span><span class=w>
</span><span class=w>          </span>echo<span class=w> </span><span class=s2>&#34;::set-output name=dh_tag::${DOCKERHUB_TAG}&#34;</span><span class=w>
</span></code></pre></div><p>の箇所で</p><ul><li>GitHub に push された最新のタグを取得</li><li>タグから v を削除</li><li>それを Docker Hub タグ用の変数に代入</li></ul><p>ということをしている。これは簡単なシェルスクリプトなので様々な応用が効くと思う。</p><h2 id=heading-1>使ってみて</h2><p>　速い。 Docker Hub にも GitHub と連携してビルドする機能があるので比べてみた。</p><h3 id=docker-hub>Docker Hub</h3><p>25分</p><a href=/post/github-docker-build-and-push/dh.png><img src=/post/github-docker-build-and-push/dh_hu97caff3ed0ee0506c5edd5f6a032f0a9_38280_800x0_resize_q90_box_2.png alt="Docker Hub では25分"></a><h3 id=github-actions>GitHub Actions</h3><p>10分</p><a href=/post/github-docker-build-and-push/gh.png><img src=/post/github-docker-build-and-push/gh_hube044bda5c48a46e2413496686798688_103960_800x0_resize_q90_box_2.png alt="GHA では10分"></a><p>　これは時間帯による影響などもあるかもしれないが、実際に動かした結果は圧倒的に速かった。また、 GHA でビルド・プッシュをするならば Docker Hub 以外（GitHub Packages など）にも展開することができて便利だと思う。</p><h2 id=heading-2>参考資料</h2><ul><li><a href=https://docs.github.com/ja/free-pro-team@latest/actions/guides/publishing-docker-images>Dockerイメージの公開 - GitHub Docs</a>　</li></ul></main><p>Tags:
<a href=/tags/docker>Docker</a>
<a href=/tags/github-actions>GitHub Actions</a></p><footer>Mochida Tsubasa (@tbsmcd)<br><a href=https://docs.google.com/forms/d/e/1FAIpQLScLrngN5Znk15zTy06N9qjO3Mi_ubIrXrX9cfYFid_2-mmbQQ/viewform>Contact</a>, <a href=/index.xml>Feed</a></footer></div></body></html>