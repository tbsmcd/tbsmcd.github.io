<!doctype html><html lang=ja><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-158035573-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-158035573-1');</script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>MySQL で ngram/mecab 全文パーサーを使うメモ | tbsmcd.net</title><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/scss/code.min.daf683076712a8fd05c112ad6575fb841b4d15640f4c87e71541744189b69260.css><link rel=stylesheet href=/css/fonts.css><link rel=stylesheet href=/scss/custom.min.5a631f3b9466ad463a34da5b8c7bfd16c44f7e3792e024e2120622091ef4437f.css><script src=/js/theme.js defer></script><link rel=apple-touch-icon sizes=57x57 href=/apple-icon-57x57.png><link rel=apple-touch-icon sizes=60x60 href=/apple-icon-60x60.png><link rel=apple-touch-icon sizes=72x72 href=/apple-icon-72x72.png><link rel=apple-touch-icon sizes=76x76 href=/apple-icon-76x76.png><link rel=apple-touch-icon sizes=114x114 href=/apple-icon-114x114.png><link rel=apple-touch-icon sizes=120x120 href=/apple-icon-120x120.png><link rel=apple-touch-icon sizes=144x144 href=/apple-icon-144x144.png><link rel=apple-touch-icon sizes=152x152 href=/apple-icon-152x152.png><link rel=apple-touch-icon sizes=180x180 href=/apple-icon-180x180.png><link rel=icon type=image/png sizes=192x192 href=/android-icon-192x192.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=96x96 href=/favicon-96x96.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><meta name=msapplication-TileColor content="#ffffff"><meta name=msapplication-TileImage content="/ms-icon-144x144.png"><meta name=theme-color content="#ffffff"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@tbsmcd"><meta name=twitter:creator content="@tbsmcd"><meta property="og:url" content="https://tbsmcd.net/post/mysql_ngram_mecab/"><meta property="og:title" content="MySQL で ngram/mecab 全文パーサーを使うメモ | tbsmcd"><meta property="og:description" content="MySQL で全文検索をしたい場合の方法、ngram を使う場合と mecab を使う場合について。"><meta name=description content="MySQL で全文検索をしたい場合の方法、ngram を使う場合と mecab を使う場合について。"><meta property="og:image" content="https://tbsmcd.net/post/mysql_ngram_mecab/ogp.png"></head><body><div class=wrapper><header>tbsmcd.net <a href=/><span>index</span></a>, <a href=/archives/><span>archives</span></a>, <a href=/tags/><span>tags</span></a>, <a href=/search/><span>search</span></a>, <a href=/profile/><span>profile</span></a> <input type=checkbox id=cb-dark-theme> Dark theme</header><main><h1 class=h1-mono-post><span>MySQL で ngram/mecab 全文パーサーを使うメモ</span></h1><div class=article-date-box><p class=article-date>Created: 2022-04-19</p></div><p>この記事では <a href=https://github.com/tbsmcd/mysql_ngram_mecab_sample>https://github.com/tbsmcd/mysql_ngram_mecab_sample</a> を用いる。</p><h2 id=heading>この保育園の名前、スペースを入れないと検索できないんだけど</h2><p>　たとえば MySQL に保育園テーブルを持っているとする。 「福岡 博多保育園」という保育園があり、</p><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>SELECT</span> <span class=o>*</span>
<span class=k>FROM</span> <span class=n>nursery</span>
<span class=k>WHERE</span> <span class=n>name</span> <span class=k>LIKE</span> <span class=s1>&#39;</span><span class=s1>%福岡博多%</span><span class=s1>&#39;</span><span class=p>;</span>
</code></pre></div><p>のようなクエリで検索してもヒットしない。こういう場合には形態素解析や N-gram を元にインデックスを作成する全文検索の手法を用いたい。</p><h3 id=heading-1>形態素解析によるインデックス</h3><p>　解析用の辞書を使い、文章を単語単位に区切って索引化する。</p><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=s1>&#39;</span><span class=s1>吾輩</span><span class=s1>&#39;</span><span class=p>,</span> <span class=s1>&#39;</span><span class=s1>は</span><span class=s1>&#39;</span><span class=p>,</span> <span class=s1>&#39;</span><span class=s1>猫</span><span class=s1>&#39;</span><span class=p>,</span> <span class=s1>&#39;</span><span class=s1>で</span><span class=s1>&#39;</span><span class=p>,</span> <span class=s1>&#39;</span><span class=s1>ある</span><span class=s1>&#39;</span><span class=p>,</span> <span class=s1>&#39;</span><span class=s1>。</span><span class=s1>&#39;</span>
</code></pre></div><p>形態素解析の例文には古来より「吾輩は猫である」冒頭を使う伝統がある。</p><p>一般に形態素解析を用いた索引は</p><ul><li>インデックス作成速度は遅い</li><li>検索ノイズは少ない</li><li>辞書が必要</li></ul><p>のような特徴があり、 MySQL mecab 全文パーサーを用いる場合には mecab をインストールする必要があるため、例えば Amazon RDS for MySQL のようなサービスでは使えない。</p><h3 id=n-gram->N-gram によるインデックス</h3><p>　N 文字ずつに分けて索引化する。 <code>n=2</code> の場合</p><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=s1>&#39;</span><span class=s1>吾輩</span><span class=s1>&#39;</span><span class=p>,</span> <span class=s1>&#39;</span><span class=s1>輩は</span><span class=s1>&#39;</span><span class=p>,</span> <span class=s1>&#39;</span><span class=s1>は猫</span><span class=s1>&#39;</span><span class=p>,</span> <span class=s1>&#39;</span><span class=s1>猫で</span><span class=s1>&#39;</span><span class=p>,</span> <span class=s1>&#39;</span><span class=s1>であ</span><span class=s1>&#39;</span><span class=p>,</span> <span class=s1>&#39;</span><span class=s1>ある</span><span class=s1>&#39;</span><span class=p>,</span> <span class=s1>&#39;</span><span class=s1>る。</span><span class=s1>&#39;</span>
</code></pre></div><p>というように。</p><p>一般に N-gram を用いた索引は</p><ul><li>インデックス作成速度は速い</li><li>検索ノイズが多い</li><li>辞書が不要</li></ul><p>のような特徴があり、 MySQL ngram 全文パーサーを用いるには MySQL5.7 以上であれば特別なものは要らない。</p><h2 id=heading-2>使い方</h2><h3 id=heading-3>設定</h3><p>　基本的には公式のドキュメントに全部書いてあるので、 ngram の場合は <code>my.cnf</code> などにトークンサイズを書けばよく、mecab の場合はそれに加えて mecab で使用する辞書のパスなどを記す必要がある。</p><p><a href=https://dev.mysql.com/doc/refman/8.0/ja/fulltext-search-ngram.html>https://dev.mysql.com/doc/refman/8.0/ja/fulltext-search-ngram.html</a></p><p><a href=https://dev.mysql.com/doc/refman/8.0/ja/fulltext-search-mecab.html>https://dev.mysql.com/doc/refman/8.0/ja/fulltext-search-mecab.html</a></p><br><p>筆者の設定 <a href=https://github.com/tbsmcd/mysql_ngram_mecab_sample/blob/d91975dd0b63989bac442a0a0c5bd4d462b2269d/mysql/my.cnf#L1>https://github.com/tbsmcd/mysql_ngram_mecab_sample/blob/d91975dd0b63989bac442a0a0c5bd4d462b2269d/mysql/my.cnf</a></p><p><a href=https://github.com/tbsmcd/mysql_ngram_mecab_sample/blob/d91975dd0b63989bac442a0a0c5bd4d462b2269d/mysql/mecabrc#L1>https://github.com/tbsmcd/mysql_ngram_mecab_sample/blob/d91975dd0b63989bac442a0a0c5bd4d462b2269d/mysql/mecabrc</a></p><h3 id=heading-4>インデックスを作成</h3><p>　今回使ったものでは <code>INSERT</code> したあとに</p><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>ALTER</span> <span class=k>TABLE</span> <span class=n>nursery_ngram</span> <span class=k>ADD</span> <span class=n>FULLTEXT</span> <span class=k>INDEX</span> <span class=n>kana_name</span> <span class=p>(</span><span class=n>name_kana</span><span class=p>,</span><span class=n>name</span><span class=p>)</span> <span class=k>WITH</span> <span class=n>PARSER</span> <span class=n>ngram</span><span class=p>;</span>
</code></pre></div><p>などをしてインデックスを作成しているが、 <code>CREATE TABLE</code> 時に作成しても良い。</p><br><p>例: <a href=https://dev.mysql.com/doc/refman/8.0/ja/fulltext-search-ngram.html>https://dev.mysql.com/doc/refman/8.0/ja/fulltext-search-ngram.html</a> より</p><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>CREATE</span> <span class=k>TABLE</span> <span class=n>articles</span> <span class=p>(</span>
  <span class=n>id</span> <span class=nb>INT</span> <span class=n>UNSIGNED</span> <span class=n>AUTO_INCREMENT</span> <span class=k>NOT</span> <span class=k>NULL</span> <span class=k>PRIMARY</span> <span class=k>KEY</span><span class=p>,</span>
  <span class=n>title</span> <span class=nb>VARCHAR</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span><span class=p>,</span>
  <span class=n>body</span> <span class=nb>TEXT</span><span class=p>,</span>
  <span class=n>FULLTEXT</span> <span class=p>(</span><span class=n>title</span><span class=p>,</span><span class=n>body</span><span class=p>)</span> <span class=k>WITH</span> <span class=n>PARSER</span> <span class=n>ngram</span>
<span class=p>)</span> <span class=n>ENGINE</span><span class=o>=</span><span class=n>InnoDB</span> <span class=nb>CHARACTER</span> <span class=k>SET</span> <span class=n>utf8mb4</span><span class=p>;</span>
</code></pre></div><h3 id=heading-5>検索クエリ</h3><p>　検索ワードと一致する度合いが高い順に表示したい場合</p><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>SELECT</span> <span class=o>*</span><span class=p>,</span> <span class=k>MATCH</span><span class=p>(</span><span class=n>name</span><span class=p>)</span> <span class=n>AGAINST</span><span class=p>(</span><span class=s1>&#39;</span><span class=s1>第2保育園</span><span class=s1>&#39;</span> <span class=k>IN</span> <span class=k>NATURAL</span> <span class=k>LANGUAGE</span> <span class=k>MODE</span><span class=p>)</span> <span class=k>as</span> <span class=n>score</span>
<span class=k>FROM</span> <span class=n>nursery_mecab</span>
<span class=k>ORDER</span> <span class=k>BY</span> <span class=n>score</span> <span class=k>DESC</span><span class=p>;</span>
</code></pre></div><p>のように使う。 <code>score</code> の値の加減を設定するとか、 <code>LIMIT</code> を設定するなどをしても良さそう。</p><br><h2 id=heading-6>インデックスの見方</h2><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>SET</span> <span class=k>GLOBAL</span> <span class=n>innodb_ft_aux_table</span><span class=o>=</span><span class=s2>&#34;</span><span class=s2>sample/nursery_ngram</span><span class=s2>&#34;</span><span class=p>;</span>
<span class=k>SELECT</span> <span class=o>*</span> <span class=k>FROM</span> <span class=n>INFORMATION_SCHEMA</span><span class=p>.</span><span class=n>INNODB_FT_INDEX_TABLE</span> <span class=k>ORDER</span> <span class=k>BY</span> <span class=n>doc_id</span> <span class=k>LIMIT</span> <span class=mi>30</span><span class=p>;</span>
</code></pre></div><br><a href=/post/mysql_ngram_mecab/ed4ccc7a.png><img src=/post/mysql_ngram_mecab/ed4ccc7a_huc9d9ce6f278e7b8df3a1611b7296f4e3_216434_800x0_resize_q90_box_2.png alt=index></a><br><h2 id=heading-7>使えるのか？</h2><p>　検索精度を上げたい場合には mecab パーサが欲しいが、 RDS 等を使っている場合には使用できない。しかし冒頭に書いたスペースの有無や部分的な表記の不一致は ngram パーサでも拾える。要は使いみち次第。せっかく調べたので覚えておきたい。</p></main><p>Tags:
<a href=/tags/mysql>MySQL</a></p><footer>Mochida Tsubasa<br>(@tbsmcd)<br><a href=https://docs.google.com/forms/d/e/1FAIpQLScLrngN5Znk15zTy06N9qjO3Mi_ubIrXrX9cfYFid_2-mmbQQ/viewform>Contact</a>, <a href=/index.xml>Feed</a></footer></div></body></html>